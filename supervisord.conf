[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor
user=root

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

# Nginx web server
[program:nginx]
command=/usr/sbin/nginx -g "daemon off;"
autostart=true
autorestart=true
stdout_logfile=/var/log/supervisor/nginx.log
stderr_logfile=/var/log/supervisor/nginx_error.log
priority=100

# Cluster Node Service
[program:cluster-node]
command=python3 /app/cluster/node.py
directory=/app
autostart=true
autorestart=true
stdout_logfile=/var/log/supervisor/cluster-node.log
stderr_logfile=/var/log/supervisor/cluster-node_error.log
environment=PYTHONPATH="/app",NODE_ENV="production"
priority=200

# GPU Monitor Service (if GPU enabled)
[program:gpu-monitor]
command=python3 /app/cluster/gpu_monitor.py
directory=/app
autostart=%(ENV_GPU_ENABLED)s
autorestart=true
stdout_logfile=/var/log/supervisor/gpu-monitor.log
stderr_logfile=/var/log/supervisor/gpu-monitor_error.log
environment=PYTHONPATH="/app"
priority=300

# Performance Metrics Collector
[program:metrics-collector]
command=python3 /app/cluster/metrics.py
directory=/app
autostart=true
autorestart=true
stdout_logfile=/var/log/supervisor/metrics.log
stderr_logfile=/var/log/supervisor/metrics_error.log
environment=PYTHONPATH="/app"
priority=400

# WebSocket Server for real-time updates
[program:websocket-server]
command=python3 /app/cluster/websocket_server.py
directory=/app
autostart=true
autorestart=true
stdout_logfile=/var/log/supervisor/websocket.log
stderr_logfile=/var/log/supervisor/websocket_error.log
environment=PYTHONPATH="/app"
priority=500

# Log rotation to prevent disk space issues
[program:log-rotator]
command=/bin/sh -c 'while true; do find /var/log -name "*.log" -size +100M -exec truncate -s 50M {} \; && sleep 3600; done'
autostart=true
autorestart=true
priority=999
